import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const corsHeaders = {'Access-Control-Allow-Origin': '*','Access-Control-Allow-Headers': '*','Content-Type': 'application/vnd.google-earth.kml+xml'}
function escapeXml(u: string): string {if (!u) return ''; return u.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;')}
serve(async (req: Request) => {if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders }); try {const supabase = createClient(Deno.env.get('SUPABASE_URL') ?? '', Deno.env.get('SUPABASE_ANON_KEY') ?? '', { auth: { persistSession: false } }); const { data, error } = await supabase.from('restaurantes').select('*').eq('corredor_id', '8aad43fc-9854-40d3-a73b-2558f42d14ad').eq('activo', true).neq('latitud', 0).neq('longitud', 0); if (error) throw error; const placemarks = (data || []).map((p: any) => {const lat = parseFloat(p.latitud); const lng = parseFloat(p.longitud); if (isNaN(lat) || isNaN(lng)) return ''; let d = ''; if (p.imagen_principal_url) d += `<img src="${escapeXml(p.imagen_principal_url)}" width="300"/><br/>`; d += `<b>üçΩÔ∏è Restaurante</b><br/>`; if (p.descripcion_corta) d += `<p>${escapeXml(p.descripcion_corta)}</p><br/>`; if (p.direccion) d += `üìç ${escapeXml(p.direccion)}`; return `<Placemark><name>${escapeXml(p.nombre)}</name><description><![CDATA[${d}]]></description><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`}).filter(x => x !== '').join('\n'); const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Zona Rosa - Restaurantes</name>${placemarks}</Document></kml>`; return new Response(kml, { headers: corsHeaders })} catch (error) {return new Response(`<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Error</name><description>${error.message}</description></Document></kml>`, { status: 500, headers: corsHeaders })}})
