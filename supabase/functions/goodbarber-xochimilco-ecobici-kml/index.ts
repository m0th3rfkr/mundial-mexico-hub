import { serve } from 'https://deno.land/std@0.168.0/http/server.ts'
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'
const corsHeaders = {'Access-Control-Allow-Origin': '*','Access-Control-Allow-Headers': '*','Content-Type': 'application/vnd.google-earth.kml+xml'}
function escapeXml(u: string): string {if (!u) return ''; return u.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&apos;')}
serve(async (req: Request) => {if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders }); try {const supabase = createClient(Deno.env.get('SUPABASE_URL') ?? '', Deno.env.get('SUPABASE_ANON_KEY') ?? '', { auth: { persistSession: false } }); const { data, error } = await supabase.from('estaciones_ecobici').select('*').eq('corredor_id', 'bc2c91a3-b564-4962-b74d-e13b6b7cb1b3').neq('latitud', 0).neq('longitud', 0); if (error) throw error; const placemarks = (data || []).map((p: any) => {const lat = parseFloat(p.latitud); const lng = parseFloat(p.longitud); if (isNaN(lat) || isNaN(lng)) return ''; let d = ''; d += `<b>ğŸš² EstaciÃ³n Ecobici</b><br/>`; if (p.capacidad) d += `<p>Capacidad: ${p.capacidad} bicicletas</p><br/>`; if (p.direccion) d += `ğŸ“ ${escapeXml(p.direccion)}`; return `<Placemark><name>${escapeXml(p.nombre)}</name><description><![CDATA[${d}]]></description><Point><coordinates>${lng},${lat},0</coordinates></Point></Placemark>`}).filter(x => x !== '').join('\n'); const kml = `<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Xochimilco - Ecobici</name>${placemarks}</Document></kml>`; return new Response(kml, { headers: corsHeaders })} catch (error) {return new Response(`<?xml version="1.0" encoding="UTF-8"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Error</name><description>${error.message}</description></Document></kml>`, { status: 500, headers: corsHeaders })}})
